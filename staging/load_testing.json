{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"BlueGreen ASG with Application LB",
   "Parameters":{  
      "Name":{  
         "Type":"String",
         "Description":"Optional: Name for the CDâ€™s and Target Groups. (Stack Name only shows in CloudFormation GUI).",
         "Default":"CD",
         "AllowedPattern":".+"
      },
      "Color":{  
         "Type":"String",
         "Description":"Required: Choose a color which is not currently deployed",
         "AllowedValues":[  
            "BLUE",
            "GREEN",
            "YELLOW"
         ]
      },
      "InstanceCount":{  
         "Type":"String",
         "Description":"Required: Number of desired instances",
         "Default":2,
         "AllowedPattern":"[2-9]|1[0-2]?"
      },
      "AMI":{  
         "Type":"String",
         "Description":"Required: ID of the AMI to spawn instances from (e.g. ami-xxxxxxxx)",
         "AllowedPattern":"(ami-[0-9a-z]{8})|(ami-[0-9a-z]{17})"
      }
   },
   "Resources":{  
      "comTG":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "Name":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"Color"
                     },
                     {  
                        "Ref":"Name"
                     },
                     "Com"
                  ]
               ]
            },
            "HealthCheckIntervalSeconds":20,
            "HealthCheckPort":"traffic-port",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":"3",
            "UnhealthyThresholdCount":"2",
            "HealthCheckPath":"/sitecore/service/healthcheck.aspx?testurl=www.chick-fil-astage.com?noredirect=1",
            "Port":80,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "VpcId":"vpc-93e9cdf7"
         }
      },
      "chickenWireTG":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "Name":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"Color"
                     },
                     {  
                        "Ref":"Name"
                     },
                     "ChickenWire"
                  ]
               ]
            },
            "HealthCheckIntervalSeconds":20,
            "HealthCheckPort":"traffic-port",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":"3",
            "UnhealthyThresholdCount":"2",
            "HealthCheckPath":"/sitecore/service/healthcheck.aspx?testurl=thechickenwire.chick-fil-astage.com?noredirect=1",
            "Port":80,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "VpcId":"vpc-93e9cdf7"
         }
      },
      "cowzVrTG":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "Name":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"Color"
                     },
                     {  
                        "Ref":"Name"
                     },
                     "CowzVR"
                  ]
               ]
            },
            "HealthCheckIntervalSeconds":20,
            "HealthCheckPort":"traffic-port",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":"3",
            "UnhealthyThresholdCount":"2",
            "HealthCheckPath":"/sitecore/service/healthcheck.aspx?testurl=cowzvr.chick-fil-astage.com?noredirect=1",
            "Port":80,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "VpcId":"vpc-93e9cdf7"
         }
      },
      "launchConfiguration":{  
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Properties":{  
            "IamInstanceProfile":"arn:aws:iam::204364282870:instance-profile/ec2-default-role",
            "ImageId":{  
               "Ref":"AMI"
            },
            "InstanceType":"c4.2xlarge",
            "KeyName":"CFA-AWS-Dev",
            "SecurityGroups":[  
               "sg-f2b76a8a"
            ],
            "UserData":{  
               "Fn::Base64":{  
                  "Fn::Join":[  
                     "\n",
                     [  
                        "<script>",
                        "powershell.exe C:\\Users\\Administrator\\Desktop\\DeployPackages\\RunWarmup.ps1",
                        "</script>",
                        "<persist>true</persist>"
                     ]
                  ]
               }
            }
         }
      },
      "autoScalingGroup":{  
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "UpdatePolicy":{  
            "AutoScalingRollingUpdate":{  
               "SuspendProcesses":[  
                  "ReplaceUnhealthy"
               ]
            },
            "AutoScalingReplacingUpdate":{  
               "SuspendProcesses":[  
                  "ReplaceUnhealthy"
               ]
            }
         },
         "Properties":{  
            "AutoScalingGroupName":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"Color"
                     },
                     {  
                        "Ref":"Name"
                     }
                  ]
               ]
            },
            "Cooldown":"30",
            "DesiredCapacity":{  
               "Ref":"InstanceCount"
            },
            "HealthCheckGracePeriod":"600",
            "HealthCheckType":"ELB",
            "LaunchConfigurationName":{  
               "Ref":"launchConfiguration"
            },
            "MaxSize":{  
               "Ref":"InstanceCount"
            },
            "MinSize":{  
               "Ref":"InstanceCount"
            },
            "VPCZoneIdentifier":[  
               "subnet-587ca072",
               "subnet-d9ac0d81"
            ],
            "TargetGroupARNs":[  
               {  
                  "Ref":"comTG"
               },
               {  
                  "Ref":"cowzVrTG"
               },
               {  
                  "Ref":"chickenWireTG"
               }
            ],
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":{  
                     "Fn::Join":[  
                        "-",
                        [  
                           {  
                              "Ref":"Color"
                           },
                           {  
                              "Ref":"Name"
                           }
                        ]
                     ]
                  },
                  "PropagateAtLaunch":true
               }
            ]
         }
      }
   }
}