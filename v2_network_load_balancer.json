{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"BlueGreen ASG with Network LB",
   "Parameters":{  
      "InstanceCount":{  
         "Type":"Number",
         "Default":1,
         "Description":"Number of desired instances in Auto Scaling Group"
      },
      "AMI":{
          "Type":"String",
          "Default":"ami-36fd354b",
          "Description":"ID of the AMI to spawn instances from."
      },
      "Subnet":{
          "Type":"String",
          "Default":"subnet-5c3b2870",
          "Description":"Subnet for both the load balancer and ASG"
      }
   },
   "Resources":{  
      "targetGroup":{  
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{  
            "Port":80,
            "Protocol":"TCP",
            "TargetType":"instance",
            "VpcId":"vpc-93e9cdf7"
         }
      },
      "Listener":{  
         "Type":"AWS::ElasticLoadBalancingV2::Listener",
         "Properties":{  
            "DefaultActions":[  
               {  
                  "TargetGroupArn":{  
                     "Ref":"targetGroup"
                  },
                  "Type":"forward"
               }
            ],
            "LoadBalancerArn":{  
               "Ref":"networkLoadBalancer"
            },
            "Port":"80",
            "Protocol":"TCP"
         }
      },
      "launchConfiguration":{  
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Properties":{  
            "IamInstanceProfile":"arn:aws:iam::204364282870:instance-profile/ec2-default-role",
            "ImageId":{"Ref":"AMI"},
            "InstanceType":"c4.2xlarge",
            "KeyName":"CFA-AWS-Dev",
            "SecurityGroups":[  
               "sg-b1b6c5c7"
            ]
         }
      },
      "autoScalingGroup":{  
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "Properties":{  
            "AutoScalingGroupName":"BlueGreenDeployment",
            "Cooldown":"30",
            "DesiredCapacity":{"Ref":"InstanceCount"},
            "HealthCheckGracePeriod":"600",
            "HealthCheckType":"ELB",
            "LaunchConfigurationName":{"Ref":"launchConfiguration"},
            "MaxSize":{"Ref":"InstanceCount"},
            "MinSize":{"Ref":"InstanceCount"},,
            "VPCZoneIdentifier":[
                {
                    "Ref":"Subnet"
                }
            ],
            "TargetGroupARNs":[  
               {  
                  "Ref":"targetGroup"
               }
            ],
            "HealthCheckGracePeriod":600
         }
      },
      "networkLoadBalancer":{  
         "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
         "Properties":{  
            "Name":"BlueGreen",
            "Type":"network",
            "Scheme":"internal",
            "IpAddressType":"ipv4",
            "Subnets":[
                {"Ref":"Subnet"}
            ] 
         }
      }
   }
}
